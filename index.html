<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pi Bot</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin-top: 10px; padding: 8px; font-size: 1em; }
    #status { font-weight: bold; font-size: 1.2em; margin-top: 15px; color: green; }
    #warning { color: red; font-weight: bold; margin-top: 10px; }
    #countdown { font-size: 1.4em; color: #005500; margin-top: 10px; }
    #stopBtn {
      padding: 10px 16px;
      font-size: 1em;
      background-color: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
      display: none;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>Pi Bot</h2>

  <label>Enter Unlock Date (YYYY-MM-DD):</label><br>
  <input type="date" id="dateInput"><br>

  <label>Enter Unlock Time (HH:MM:SS):</label><br>
  <input type="time" id="timeInput" step="1"><br>

  <label>Enter Amount to Send:</label><br>
  <input type="number" id="amountInput" placeholder="e.g. 2800" min="0" step="0.000001"><br>

  <button onclick="startBot()">Start Bot</button>

  <p><strong>Countdown:</strong> <span id="countdown"></span></p>
  <p id="status">Waiting for input...</p>
  <p id="warning"></p>
  <button id="stopBtn" onclick="stopRetry()">Stop Retry</button>

  <script>
    const bitgetAddress = "MDFNWH6ZFJVHJDLBMNOUT35X4EEKQVJAO3ZDL4NL7VQJLC4PJOQFWAAAAAAEJJJMOUSDC";
    let unlockTime = null;
    let sendInterval = null;
    let piAmount = null;
    let logs = [];

    window.Pi.init({ version: "2.0", sandbox: false });

    window.Pi.authenticate(["username", "payments"], onAuthSuccess, onAuthFailure);

    function onAuthSuccess(auth) {
      document.getElementById("status").innerText = "Authenticated. Ready.";
      document.getElementById("warning").innerText = "";
    }

    function onAuthFailure(error) {
      document.getElementById("status").innerText = "Auth failed.";
      document.getElementById("warning").innerText = "Wallet not connected. Please ensure Pi Wallet is open in Pi Browser.";
    }

    function startBot() {
      const date = document.getElementById("dateInput").value;
      const time = document.getElementById("timeInput").value;
      piAmount = document.getElementById("amountInput").value;

      if (!date || !time || !piAmount || parseFloat(piAmount) <= 0) {
        alert("Please fill in all fields with valid values.");
        return;
      }

      unlockTime = new Date(`${date}T${time}Z`).getTime();
      document.getElementById("status").innerText = "Waiting for unlock time...";
      logs.push(`Bot started at ${new Date().toISOString()}`);
      logs.push(`Unlock scheduled for: ${new Date(unlockTime).toISOString()}`);
      logs.push(`Amount: ${piAmount} PI`);

      const interval = setInterval(() => {
        const now = Date.now();
        const diff = unlockTime - now;

        if (diff <= 0) {
          clearInterval(interval);
          document.getElementById("countdown").innerText = `0h 0m 0s`;
          attemptSendLoop();
        } else {
          const hrs = Math.floor(diff / 3600000);
          const mins = Math.floor((diff % 3600000) / 60000);
          const secs = Math.floor((diff % 60000) / 1000);
          document.getElementById("countdown").innerText = `${hrs}h ${mins}m ${secs}s`;
        }
      }, 500);
    }

    function attemptSendLoop() {
      document.getElementById("status").innerText = "Unlock hit. Attempting to send...";
      document.getElementById("stopBtn").style.display = "inline-block";

      sendInterval = setInterval(() => {
        const timestamp = new Date().toISOString();
        logs.push(`[${timestamp}] Attempting transaction...`);

        window.Pi.createPayment({
          amount: piAmount,
          memo: "Auto-send to Bitget",
          to: bitgetAddress
        }).then((payment) => {
          clearInterval(sendInterval);
          document.getElementById("status").innerText = "Success! Tx ID: " + payment.identifier;
          document.getElementById("stopBtn").style.display = "none";
          logs.push(`[${timestamp}] SUCCESS: Transaction ID ${payment.identifier}`);
          downloadLog();
          alert("Transaction sent successfully!");
        }).catch((err) => {
          logs.push(`[${timestamp}] Retry failed: ${err.message}`);
          document.getElementById("status").innerText = "Retrying... " + err.message;
        });
      }, 1000);
    }

    function stopRetry() {
      if (sendInterval) {
        clearInterval(sendInterval);
        sendInterval = null;
        document.getElementById("status").innerText = "Retry loop stopped manually.";
        document.getElementById("stopBtn").style.display = "none";
        logs.push(`[${new Date().toISOString()}] Retry stopped by user.`);
        downloadLog();
      }
    }

    function downloadLog() {
      const blob = new Blob([logs.join("\n")], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `pi_bot_log_${Date.now()}.txt`;
      link.click();
    }
  </script>
</body>
</html>
